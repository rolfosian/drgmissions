## **Deep Rock Galactic lua scripts for use with [RE-UE4SS lua API](https://github.com/UE4SS-RE/RE-UE4SS/) to fetch current mission and deep dive data for flask**

- To run DRG headless, use command line arg `-nullrhi` when running the game.
- Tested working with a Windows 10 virtual machine using `-nullrhi` (Requires OpenGL or dx11 for the UE4SS hook).
- Make sure to [skip intro videos](https://www.pcgamingwiki.com/wiki/Deep_Rock_Galactic#Skip_intro_videos) and also use `-nosplash` command line arg if desired.
- Be sure to disable Steam cloud save synchronization.
- Unzip UE4SS into steamapps\common\Deep Rock Galactic\FSD\Binaries\Win64 - this is also the CWD of the scripts run by the UE4SS hook.

* [This lua script will collect all of the missions generated by DRG up until the date set by the target_date variable](https://github.com/rolfosian/drgmissions/blob/main/mods/BulkMissionsScraper/Scripts/main.lua). Its corresponding python script for automated `mods.txt` and easy user input for setting the target date is [BulkMissions_Run.py](https://github.com/rolfosian/drgmissions/blob/main/BulkMissions_Run.py). This python script goes in `Deep Rock Galactic\FSD\Binaries\Win64\`. The python interpreter is required to be run with administrator privileges with this script.
- `Deep Rock Galactic\FSD.exe` **AND** `Deep Rock Galactic\FSD\Binaries\Win64\FSD-Win64-Shipping.exe` **AND ALSO** `Steam.exe` **ARE ALL** required to be run with administrator privileges in order for this script to be able to modify the system clock and run without errors!

- [This lua script](https://github.com/rolfosian/drgmissions/blob/main/mods/DailyDealsScraper/Scripts/main.lua) and its [corresponding python script](https://github.com/rolfosian/drgmissions/blob/main/DailyDeals_Run.py) will fetch 365 days worth of daily deals. Adjust the total_days variable in the lua script if you want more or less.

- If running the clock changing scripts in a VM, make sure to turn off guest/host timesync, IE: https://www.virtualbox.org/manual/ch09.html#disabletimesync `VBoxManage setextradata VM-name "VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled" 1`

- The `.*_Run.py` python scripts will handle toggling the system automatic time sync settings on and off.

- [This lua script will fetch the current Deep Dive data and exit the game in short order](https://github.com/rolfosian/drgmissions/blob/main/mods/DeepDivesScraper/Scripts/main.lua)
- ~~I have set a crontab entry: `59 10 * * 4 /usr/bin/wakeonlan XX:XX:XX:XX:XX:XX` on my home server to automate this. (cron of course requires adjustment if system clock is not UTC). It sends magic packets to wake a junker hardware tertiary machine I built out of old trash every Thursday at 10:59 which in turn runs [this script](https://github.com/rolfosian/drgmissions/blob/main/DeepDives_Run.py) via [this .bat (not the setup script but the script it generates)](https://github.com/rolfosian/drgmissions/blob/main/vm_fresh_setup.bat#L176) and Task Scheduler On event - Log: System, Source: Microsoft-Windows-Power-Troubleshooter, Event ID: 1 (On wake from sleep). Requires automatic logon of administrator account. This of course could also be done with a Virtual Machine instead.~~ Now using a Win10 Virtual Machine, and running on startup via shortcut to [Run_DeepDives.bat (not the setup script but the script it generates)](https://github.com/rolfosian/drgmissions/blob/main/vm_fresh_setup.bat#L176) in startup folder, requires automatic logon of Windows user and Steam at startup of course also.

## **Flask Server**
- [this setup script](https://github.com/rolfosian/drgmissions/blob/main/flask/setup.py) will take care of the setup of python venv, just take the [flask_directory](https://github.com/rolfosian/drgmissions/blob/main/flask/) and rename it to something else, then put it in where you want to run the service and venv, and run the setup. Follow the prompts to set up the venv and systemd service. It will make a nested project root and copy everything to it. **Make Sure to note down the cfg.json it generates to copy to the scraper_cfg.json for the windows vm or simply input your own manually**. It includes a prompt for setting up an nginx reverse proxy with another prompt for if you want to use certbot also. **WORK IN PROGRESS DONT RUN THIS**

## **Virtual Machine Setup**
- Pick a VM Software (Virtualbox, VMWare, Qemu, etc) and install a Windows 10 machine. Give it at least 4 cores or it will run very poorly, and 4-6GB of ram. Make sure to enable dx11 or opengl for it also (consult your chosen vm software documentation). Pick your poison of which version of windows, I've been using LTSC 21H2, it's more forgiving on disabling updates and stuff and is just generally more lightweight than the other distros.
- Make sure to turn off guest/host timesync if your chosen vm software has it; IE: https://www.virtualbox.org/manual/ch09.html#disabletimesync `VBoxManage setextradata VM-name "VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled" 1` **This is critical**
- [This batch script](https://github.com/rolfosian/drgmissions/blob/main/vm_fresh_setup.bat) will handle enabling the automatic logon of the windows user account and disables UAC as well as prompts for Windows GUI performance options plus sets the system clock timezone to UTC and the correct date format for the lua scripts. It will also download and install python + its requests and psutil modules before installing steam and setting all relevant executables to be run with elevated privileges via the registry, as well as disabling automatic Windows updates.
- Before running the batch script, have your [cfg.json](https://github.com/rolfosian/drgmissions/blob/main/flask/cfg.json) ready from the flask server setup.
- Steam auto logon will have to be enabled manually and DRG has to be installed manually too after this however, I'm not going to write a gui script for all that stuff sorry not sorry. **Also, if you do something like copy paste an entire steam folder to the new machine without using SteamSetup.exe you'll probably break the script unless you accomodate for it yourself specifically so don't do that. Copy just the steamapps folder after running this script instead if you want to save bandwidth! (You can still manually install steam if you want to before running this script but make sure to do so using SteamSetup.exe...)** I wouldn't recommend running this on anything other than a fresh windows install though.
- **Make sure to set command line args `-nullrhi` and `-nosplash` in the steam game launch options as well as [skip intro videos](https://www.pcgamingwiki.com/wiki/Deep_Rock_Galactic#Skip_intro_videos)** after running the batch script and installing DRG!
- After following the prompts in the batch script and installing DRG, copy the `cfg.json` generated from the flask server setup as `scraper_cfg.json`, `.*_Run.py`, `drgmissions_scraper_utils.py`, and `drgmissions_validator.py` scripts to the `Deep Rock Galactic\FSD\Binaries\Win64` folder, unzip UE4SS into that same folder, then finally copy and merge the [mods](https://github.com/rolfosian/drgmissions/tree/main/mods) folder.

## **TODO**
- **Public Enemy Number One**: Check and Update Deep Dive scraper weekly to accomodate currently unknown configurations (havent seen any unknowns in months), **contingencies for if Steam misbehaves**
- ~~[Scripts for registry entries for automatic login and](https://github.com/rolfosian/drgmissions/blob/main/vm_fresh_setup.bat)~~ cron entry for starting vm weekly for [DeepDives_Run.py](https://github.com/rolfosian/drgmissions/blob/main/DeepDives_Run.py)
- Fix canvas mission icon jaggies in js
- Move static site to github pages, set up github actions for deployment of metadata and edit `.*_Run` scripts accordingly
- ~~Figure out a solution to reduce required delay between iterations for accurate data to be collected by the 30 minute incrementer~~
- Figure out how to manipulate wine(?) system clock with hook on linux
- ~~Clean up and convert Complexity/Length finalization to table lookup seriously look at it its so disgusting DO SOMETHING~~
- ~~Parallelize png rendering and arraying functions and change png route args to codenames instead of indexing once possible~~ Moved png rendering and arraying to thread pools, but the gains are miniscule because of thread management overhead, the GIL, and I/O bound image rendering. It also requires a hard restart of the interpreter so `gunicorn --reload` isn't feasible. Needs processing pools to see gains that are bigger than fractions of a millisecond, but the vps is only 1 vcore so I'm not going to bother debugging the circular multiprocessing import at this stage.

-------------------------------------------------------------------------------------------
***This is a third-party project and it is not affiliated, endorsed, or sponsored by Ghost Ship Games. The use of Deep Rock Galactic's in-game assets in this project is solely for illustrative purposes and does not imply any ownership or association with the game or its developers. All copyrights and trademarks belong to their respective owners. For official information about Deep Rock Galactic, please visit the official Ghost Ship Games website.***
